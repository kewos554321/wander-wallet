# Issue Tracking

## Requirements (需求)

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| 4 | 支出可以增加支出日期 | 低 | P0 | 已完成 | 2025-12-17 |
| 2 | 調整傳到 LINE Group 的訊息 UI，並讓 delete、批次操作、update 可以發送群組通知 | 中 | P1 | 已完成 | 2025-12-17 |
| 6 | 調整分享連結，讓使用者直接進入 project 畫面，並統一 join project 連結 | 低 | P1 | 已完成 | 2025-12-17 |
| 3 | 支出可以增加消費清單圖片上傳功能 | 中高 | P2 | 待處理 | 2025-12-17 |
| 1 | 串接 AI 模型，讓 user 可以提供未整理的文本，自動轉換為新的支出紀錄 | 高 | P2 | 待處理 | 2025-12-17 |
| 5 | 支出可以增加地點，地點可以透過 Google Maps/Places 點選 | 中高 | P3 | 待處理 | 2025-12-17 |
| 7 | 讓 user 點擊 project 頁面上的最近支出，可以直接到該筆明細編輯頁面 | 低 | P1 | 已完成 | 2025-12-17 |
| 8 | 系統層級 Log 系統，用於生產環境追蹤 bug | 低 | P1 | 已完成 | 2025-12-18 |

---

## 難度評估說明

### #4 支出日期 (低)
- 僅需在 Expense model 加 `expenseDate` 欄位
- UI 加 date picker
- 影響範圍小

### #2 LINE 通知擴充 (中)
- `lib/liff.ts` 已有 `sendExpenseNotificationToChat`，支援 create/update/delete
- 需要在 delete、batch、update 操作處呼叫通知
- UI 調整 Flex Message 模板

### #6 分享連結統一 (低)
- 現有 shareCode 機制完整
- 主要是 routing 調整
- 改變 join 流程的跳轉邏輯

### #7 最近支出點擊跳轉 (低)
- 加 onClick handler 跳轉到編輯頁
- 路由已存在 `/projects/[id]/expenses/[expenseId]`
- 純前端 UI 調整

### #3 圖片上傳 (中高)
- 需要檔案儲存方案 (Cloudinary/S3/Vercel Blob)
- DB schema 加 imageUrl 欄位
- 前端上傳元件

### #1 AI 文本解析 (高)
- 需串接 AI API (OpenAI/Claude)
- Prompt engineering 解析非結構化文本
- 錯誤處理和 fallback
- 額外 API 成本

### #5 Google 地點選擇 (中高)
- Google Places API 整合
- DB schema 加地點欄位
- Google API 計費考量
- 地圖 UI 元件

### #8 系統層級 Log 系統 (低)
- 建立 `lib/logger.ts` 工具
- 支援 log levels: debug/info/warn/error
- 結構化 JSON 輸出，方便 Vercel 日誌查詢
- API Route 專用 logger 附帶 requestId 追蹤

---

## 建議開發順序

1. **#4 支出日期** - 快速完成，立即提升實用性
2. **#7 最近支出點擊跳轉** - 純前端，快速完成
3. **#6 分享連結** - 改善 UX，工作量小
4. **#2 LINE 通知** - 團隊協作核心功能
5. **#3 圖片上傳** - 需先決定儲存方案
6. **#1 AI 解析** - 進階功能，可作為亮點
7. **#5 地點功能** - 非核心，可後續迭代

---

## Refactor (重構優化)

### API 層重構

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| R1 | 建立 API 認證中間件 `lib/api-middleware.ts`，統一 `getAuthUser` 和成員權限檢查 | 中 | P1 | 待處理 | 2025-12-18 |
| R2 | 建立統一 API 回應格式 `lib/api-response.ts`，標準化 success/error 結構 | 中 | P1 | 待處理 | 2025-12-18 |
| R3 | 建立統一驗證層 `lib/validators.ts`，集中金額、日期、參與者等驗證邏輯 | 中 | P1 | 待處理 | 2025-12-18 |
| R4 | 建立統一錯誤處理 `lib/error-handler.ts`，處理 Prisma 錯誤碼 (P2002/P2003/P2025) | 低 | P2 | 待處理 | 2025-12-18 |

### 類型系統重構

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| R5 | 集中類型定義到 `types/index.ts`，消除組件中重複的 Member/Expense/Project 介面 | 低 | P0 | 待處理 | 2025-12-18 |

### 工具函數整合

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| R6 | 建立格式化工具 `lib/formatters.ts`，統一金額、日期、百分比格式化 | 低 | P2 | 待處理 | 2025-12-18 |
| R7 | 建立開發模式配置 `lib/dev-mode.ts`，集中 DEV_MODE 判斷和測試用戶資料 | 低 | P2 | 待處理 | 2025-12-18 |

### 組件優化

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| R8 | 拆分 ExpenseForm (862行) 為 Calculator、ParticipantSelector、SplitModeSelector 等子組件 | 中 | P2 | 待處理 | 2025-12-18 |

### 資料獲取優化

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| R9 | 引入 React Query/SWR 進行資料快取，減少重複 API 請求 | 高 | P3 | 待處理 | 2025-12-18 |

---

## Refactor 難度評估

### R1 API 認證中間件 (中)
- 12 個 API 檔案有重複的 `getAuthUser` + 成員權限檢查
- 建立 `withAuth()` 和 `withProjectAccess()` wrapper
- 可減少 30-40% API 程式碼

### R2 統一 API 回應格式 (中)
- 目前有 3 種以上的錯誤回應格式
- 建立 `apiSuccess()` / `apiError()` 標準函數
- 前端需配合調整

### R3 統一驗證層 (中)
- 金額/日期/參與者驗證散落在 4-5 個 API 檔案
- 建立 `validators.expense` / `validators.project` 命名空間
- 可選：引入 Zod 強化類型安全

### R4 統一錯誤處理 (低)
- 建立 Prisma 錯誤碼對應表
- 統一錯誤日誌格式

### R5 集中類型定義 (低)
- `Member` / `Expense` / `Project` 在多個組件重複定義
- 建立單一 types/index.ts
- 無破壞性風險

### R6 格式化工具 (低)
- `Math.round(value * 100) / 100` 散落多處
- 金額格式化沒有統一函數
- 建立 `formatters.currency()` / `formatters.number()`

### R7 開發模式配置 (低)
- `DEV_MODE` 在 3 個檔案重複定義
- 測試用戶資料硬編碼在多處
- 集中管理提高可維護性

### R8 拆分 ExpenseForm (中)
- 862 行單一檔案，5 種不同職責
- 拆分為 3-4 個子組件
- 提高可測試性和複用性

### R9 React Query/SWR (高)
- 目前 ExpenseForm 重複獲取 members/project 資料
- 無快取機制
- 需要安裝依賴和全局配置

---

## Refactor 建議執行順序

**Phase 1 - 基礎設施 (低風險快速見效)**
1. R5 集中類型定義
2. R7 開發模式配置

**Phase 2 - API 層優化 (核心改進)**
3. R2 統一 API 回應格式
4. R1 API 認證中間件
5. R3 統一驗證層
6. R4 統一錯誤處理

**Phase 3 - 前端優化 (可選)**
7. R6 格式化工具
8. R8 拆分 ExpenseForm
9. R9 React Query/SWR

---

## UI/UX 小功能 (Small Features)

### 列表體驗

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| U1 | 支出列表加入下拉刷新 (Pull to refresh) | 低 | P2 | 待處理 | 2025-12-18 |
| U2 | 支出列表支援無限滾動分頁，避免一次載入過多資料 | 中 | P3 | 待處理 | 2025-12-18 |
| U3 | 支出列表加入日期分組顯示 (今天/昨天/本週/更早) | 低 | P2 | 待處理 | 2025-12-18 |
| U4 | 空狀態頁面加入插圖動畫，提升視覺體驗 | 低 | P3 | 待處理 | 2025-12-18 |

### 視覺反饋

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| U5 | 載入中狀態使用 Skeleton Loading 取代純文字 | 低 | P1 | 待處理 | 2025-12-18 |
| U6 | 新增/編輯/刪除成功後顯示 Toast 通知 | 低 | P1 | 待處理 | 2025-12-18 |
| U7 | 支出卡片加入 Swipe to Delete 手勢操作 | 中 | P3 | 待處理 | 2025-12-18 |
| U8 | 金額變化時加入數字滾動動畫效果 | 低 | P3 | 待處理 | 2025-12-18 |

### 資料視覺化

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| U9 | 支出摘要加入類別圓餅圖/長條圖 | 中 | P2 | 待處理 | 2025-12-18 |
| U10 | Project 頁面加入支出趨勢折線圖 (每日/每週) | 中 | P3 | 待處理 | 2025-12-18 |
| U11 | 成員貢獻度排行榜視覺化顯示 | 低 | P3 | 待處理 | 2025-12-18 |

### 操作優化

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| U12 | 長按支出卡片直接進入多選模式 | 低 | P2 | 待處理 | 2025-12-18 |
| U13 | 金額輸入加入快速金額按鈕 ($100/$500/$1000) | 低 | P2 | 待處理 | 2025-12-18 |
| U14 | 搜尋/篩選支出功能 (依類別、金額範圍、日期) | 中 | P2 | 待處理 | 2025-12-18 |
| U15 | 支出列表支援排序 (金額/日期/類別) | 低 | P2 | 待處理 | 2025-12-18 |

### 細節優化

| # | 描述 | 難度 | 優先級 | 狀態 | 日期 |
|---|------|------|--------|------|------|
| U16 | 頭像 hover/長按顯示成員詳細資訊 tooltip | 低 | P3 | 待處理 | 2025-12-18 |
| U17 | 支出金額超過設定閾值時顯示警示樣式 | 低 | P3 | 待處理 | 2025-12-18 |
| U18 | 表單輸入加入字數限制提示 | 低 | P3 | 待處理 | 2025-12-18 |
| U19 | 深色模式切換加入過渡動畫 | 低 | P3 | 待處理 | 2025-12-18 |

---

## Bug Fixes (錯誤修復)

| # | 描述 | 原因 | 狀態 | 日期 |
|---|------|------|------|------|
| | | | | |

---

### 狀態說明
- `待處理` - 尚未開始
- `進行中` - 正在處理
- `已完成` - 已修復/完成
- `擱置` - 暫時不處理

### 優先級說明
- `P0` - 最高優先，應立即處理
- `P1` - 高優先，核心功能
- `P2` - 中優先，重要但不緊急
- `P3` - 低優先，nice to have
